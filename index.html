<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Erbha</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram Mini App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Monetag SDK (Base Tag) -->
  <script src='//libtl.com/sdk.js'
          data-zone='10376707'
          data-sdk='show_10376707'></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #ffffff;
      text-align: center;
    }
    .box {
      padding: 30px;
      max-width: 420px;
      margin: 0 auto;
    }
    h1 {
      color: #22c55e;
      font-size: 36px;
      margin-bottom: 5px;
    }
    p {
      opacity: 0.85;
      margin-top: 0;
    }
    .points {
      margin-top: 20px;
      font-size: 18px;
      background: rgba(255,255,255,0.08);
      padding: 12px;
      border-radius: 12px;
    }
    button {
      background: #22c55e;
      border: none;
      padding: 16px;
      font-size: 17px;
      border-radius: 14px;
      cursor: pointer;
      margin-top: 25px;
      color: #000;
      font-weight: bold;
      width: 100%;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .msg {
      margin-top: 15px;
      font-size: 14px;
      min-height: 18px;
    }
    .ok { color: #86efac; }
    .err { color: #fca5a5; }
    .note {
      font-size: 12px;
      opacity: 0.6;
      margin-top: 15px;
    }
  </style>
</head>

<body>
  <div class="box">
    <h1>ğŸ® Erbha</h1>
    <p>Play â€“ Earn â€“ Win</p>

    <div class="points">
      â­ Your Points: <b><span id="points">0</span></b>
    </div>

    <button id="watchBtn" onclick="watchRewardedAd()">
      ğŸ‘€ Watch Ad & Earn
    </button>

    <div class="msg" id="msg"></div>

    <div class="note">
      Ads appear only after user interaction
    </div>
  </div>

  <script>
    /* ===============================
       CONFIG (Supabase)
       =============================== */
    const SUPABASE_URL = "https://tvubifjpkrsjrwjkayvm.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dWJpZmpwa3JzanJ3amtheXZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MTg2MzQsImV4cCI6MjA4MjI5NDYzNH0.Qfr7d65GaV2PojXc036e2UX7s9m_qo9L4fnbpdHxppE";

    /* ===============================
       UI Refs
       =============================== */
    const pointsEl = document.getElementById("points");
    const msgEl = document.getElementById("msg");
    const btn = document.getElementById("watchBtn");

    function setMsg(text, cls) {
      msgEl.textContent = text || "";
      msgEl.className = "msg " + (cls || "");
    }

    /* ===============================
       Local Fallback Points (Backup)
       =============================== */
    const POINTS_KEY = "erbha_points";

    function loadLocalPoints() {
      const p = Number(localStorage.getItem(POINTS_KEY) || 0);
      pointsEl.textContent = p;
      return p;
    }

    function saveLocalPoints(p) {
      localStorage.setItem(POINTS_KEY, p);
      pointsEl.textContent = p;
    }

    /* ===============================
       Telegram + Server Balance
       =============================== */
    let authed = false;
    let tgId = null;
    let serverBalance = 0;

    async function postFunction(path, body) {
      const res = await fetch(`${SUPABASE_URL}/functions/v1/${path}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON,
          "Authorization": `Bearer ${SUPABASE_ANON}`
        },
        body: JSON.stringify(body)
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || "Request failed");
      return data;
    }

    async function authWithTelegram() {
      try {
        const TG = window.Telegram?.WebApp;
        if (!TG) throw new Error("Open inside Telegram");

        TG.ready();
        TG.expand();

        const initData = TG.initData;
        if (!initData) throw new Error("Missing initData");

        const out = await postFunction("auth", { initData }); // { tg_id, balance }
        tgId = out.tg_id;
        serverBalance = Number(out.balance || 0);
        pointsEl.textContent = String(serverBalance);

        authed = true;
        setMsg("âœ… Verified with Telegram", "ok");
      } catch (e) {
        // fallback to local
        authed = false;
        tgId = null;
        serverBalance = 0;

        loadLocalPoints();
        setMsg("â„¹ï¸ Local mode (open from Telegram to sync points).", "");
        console.log("Auth failed:", e?.message || e);
      }
    }

    // Start auth on load
    authWithTelegram();

    /* ===============================
       Monetag â€“ Rewarded Interstitial
       =============================== */
    async function watchRewardedAd() {
      setMsg("");
      btn.disabled = true;

      try {
        if (typeof show_10376707 !== "function") {
          throw new Error("Ad is loading, try again in a few seconds.");
        }

        // Show rewarded interstitial
        await show_10376707();

        // After ad watched successfully:
        if (authed && tgId) {
          // âœ… Ø§Ù„Ø£ÙØ¶Ù„: Ù†Ø¶ÙŠÙ Ù†Ù‚Ø§Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± (ÙŠØªØ·Ù„Ø¨ Edge Function Ø§Ø³Ù…Ù‡Ø§ reward)
          // Ø¥Ø°Ø§ reward Ù„Ø³Ù‡ Ù…Ø§ Ø³ÙˆÙŠØªÙ‡Ø§ØŒ Ø±Ø§Ø­ ÙŠØ¹Ø·ÙŠÙƒ Error ÙˆÙ†Ø±Ø¬Ø¹ Ù†Ø¶ÙŠÙ Ù…Ø­Ù„ÙŠ Ù…Ø¤Ù‚ØªØ§Ù‹.
          try {
            const event_key = `${tgId}:${Date.now()}:${Math.random().toString(16).slice(2)}`;
            const rewardOut = await postFunction("reward", {
              tg_id: tgId,
              event_key,
              points: 5
            });
            serverBalance = Number(rewardOut.balance || serverBalance);
            pointsEl.textContent = String(serverBalance);
            setMsg("âœ… You watched the ad! +5 points added (server).", "ok");
          } catch (err) {
            // Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ùˆ reward ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
            serverBalance += 5;
            pointsEl.textContent = String(serverBalance);
            setMsg("âœ… Ad done! +5 points (server reward not set yet).", "ok");
            console.log("Reward function not ready:", err?.message || err);
          }
        } else {
          // Local fallback
          const current = loadLocalPoints();
          saveLocalPoints(current + 5);
          setMsg("âœ… You watched the ad! +5 points added (local).", "ok");
        }

      } catch (e) {
        setMsg(`âŒ ${e.message || "Ad not completed. No reward."}`, "err");
      } finally {
        btn.disabled = false;
      }
    }

    // expose for button
    window.watchRewardedAd = watchRewardedAd;
  </script>
</body>
</html>
