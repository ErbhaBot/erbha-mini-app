<script>
  /* ===============================
     CONFIG (Supabase)
     =============================== */
  const SUPABASE_URL = "https://tvubifjpkrsjrwjkayvm.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dWJpZmpwa3JzanJ3amtheXZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MTg2MzQsImV4cCI6MjA4MjI5NDYzNH0.Qfr7d65GaV2PojXc036e2UX7s9m_qo9L4fnbpdHxppE";

  /* ===============================
     UI Refs
     =============================== */
  const pointsEl = document.getElementById("points");
  const msgEl = document.getElementById("msg");
  const btn = document.getElementById("watchBtn");

  function setMsg(text, cls) {
    msgEl.textContent = text || "";
    msgEl.className = "msg " + (cls || "");
  }

  /* ===============================
     Local Fallback (Backup)
     =============================== */
  const POINTS_KEY = "erbha_points";
  function loadLocalPoints() {
    const p = Number(localStorage.getItem(POINTS_KEY) || 0);
    pointsEl.textContent = p;
    return p;
  }
  function saveLocalPoints(p) {
    localStorage.setItem(POINTS_KEY, p);
    pointsEl.textContent = p;
  }

  /* ===============================
     Telegram + Server Balance
     =============================== */
  let authed = false;
  let tgId = null;
  let serverBalance = 0;
  let initDataCached = "";

  async function postFunction(path, body) {
    const res = await fetch(`${SUPABASE_URL}/functions/v1/${path}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_ANON,
        "Authorization": `Bearer ${SUPABASE_ANON}`
      },
      body: JSON.stringify(body)
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data?.error || "Request failed");
    return data;
  }

  async function authWithTelegram() {
    try {
      const TG = window.Telegram?.WebApp;
      if (!TG) throw new Error("Open inside Telegram");

      TG.ready();
      TG.expand();

      const initData = TG.initData;
      initDataCached = initData || "";
      if (!initData) throw new Error("Missing initData");

      const out = await postFunction("auth", { initData }); // { tg_id, balance }
      tgId = out.tg_id;
      serverBalance = Number(out.balance || 0);
      pointsEl.textContent = String(serverBalance);

      authed = true;
      setMsg("✅ Verified with Telegram", "ok");
    } catch (e) {
      authed = false;
      tgId = null;
      serverBalance = 0;

      loadLocalPoints();
      setMsg("ℹ️ Local mode (open from Telegram to sync points).", "");
      console.log("Auth failed:", e?.message || e);
    }
  }

  // Start auth on load
  authWithTelegram();

  /* ===============================
     Monetag – Rewarded Interstitial (SECURE)
     =============================== */
  async function watchRewardedAd() {
    setMsg("");
    btn.disabled = true;

    try {
      if (typeof show_10376707 !== "function") {
        throw new Error("Ad is loading, try again in a few seconds.");
      }

      // 1) Show rewarded ad
      await show_10376707();

      // 2) Must be verified
      if (!authed || !initDataCached) {
        throw new Error("Not verified with Telegram.");
      }

      // 3) Call reward function on server (initData-based)
      const event_key = `${Date.now()}:${Math.random().toString(16).slice(2)}`;

      const res = await fetch(`${SUPABASE_URL}/functions/v1/reward`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON,
          "Authorization": `Bearer ${SUPABASE_ANON}`
        },
        body: JSON.stringify({ initData: initDataCached, event_key, points: 5 })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || `Reward failed (${res.status})`);

      serverBalance = Number(data.balance || 0);
      pointsEl.textContent = String(serverBalance);
      setMsg("✅ You watched the ad! +5 points added (server).", "ok");
    } catch (e) {
      setMsg("❌ " + (e?.message || e), "err");
      console.log("Reward error:", e);
    } finally {
      btn.disabled = false;
    }
  }

  /* ===============================
     Withdraw (SECURE)
     =============================== */
  async function requestWithdraw() {
    try {
      if (!authed || !initDataCached) throw new Error("Not verified with Telegram.");

      const amount = Number(document.getElementById("w_amount").value || 0);
      const method = String(document.getElementById("w_method").value || "");
      const address = String(document.getElementById("w_address").value || "");

      const res = await fetch(`${SUPABASE_URL}/functions/v1/withdraw`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON,
          "Authorization": `Bearer ${SUPABASE_ANON}`
        },
        body: JSON.stringify({
          initData: initDataCached,
          amount_points: amount,
          payout_method: method,
          payout_address: address
        })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || `Withdraw failed (${res.status})`);

      serverBalance = Number(data.balance || 0);
      pointsEl.textContent = String(serverBalance);
      setMsg("✅ Withdraw request sent (pending).", "ok");
    } catch (e) {
      setMsg("❌ " + (e?.message || e), "err");
      console.log("Withdraw error:", e);
    }
  }

  // expose for buttons
  window.watchRewardedAd = watchRewardedAd;
  window.requestWithdraw = requestWithdraw;
</script>
