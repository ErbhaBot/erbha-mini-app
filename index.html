<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Erbha</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Telegram Mini App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Monetag SDK -->
  <script src='//libtl.com/sdk.js'
          data-zone='10376707'
          data-sdk='show_10376707'></script>

  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#0f172a;color:#fff;text-align:center}
    .box{padding:30px;max-width:420px;margin:0 auto}
    h1{color:#22c55e;font-size:36px;margin-bottom:5px}
    p{opacity:.85;margin-top:0}
    .points{margin-top:20px;font-size:18px;background:rgba(255,255,255,.08);padding:12px;border-radius:12px}
    button{background:#22c55e;border:none;padding:16px;font-size:17px;border-radius:14px;cursor:pointer;margin-top:16px;color:#000;font-weight:700;width:100%}
    button:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:15px;font-size:14px;min-height:18px}
    .ok{color:#86efac}
    .err{color:#fca5a5}
    .note{font-size:12px;opacity:.6;margin-top:15px}
    input,select{padding:12px;border-radius:12px;border:none;width:100%;box-sizing:border-box}
    .grid{margin-top:10px;display:grid;gap:10px}
  </style>
</head>

<body>
  <div class="box">
    <h1>ğŸ® Ø§Ø±Ø¨Ø­Ù‡Ø§</h1>
    <p>Ø´Ø§Ù‡Ø¯ - Ø§Ø±Ø¨Ø­</p>

    <div class="points">
      â­ Ù†Ù‚Ø§Ø·Ùƒ : <b><span id="points">0</span></b>
    </div>
    
    <button onclick="toggleInfo()" style="margin-top:10px;">
  â„¹ï¸ ÙƒÙŠÙ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ØŸ
</button>

<div id="rewardInfo" class="note" style="display:none;">
  â€¢ Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØ§ÙƒØ³Ø¨ Ù†Ù‚Ø§Ø·<br>
  â€¢ ÙƒÙ„ Ø¥Ø¹Ù„Ø§Ù† = +2 Ù†Ù‚Ø·Ø©<br>
  â€¢ ÙƒÙ„ 100 Ù†Ù‚Ø·Ø© = 0.10$<br>
  â€¢ ÙƒÙ„ 1000 Ù†Ù‚Ø·Ø© = 1$<br>
  â€¢ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ: 5000 Ù†Ù‚Ø·Ø© (5$)
</div>

    <button id="watchBtn" onclick="watchRewardedAd()">
      ğŸ‘€ Ø´Ø§Ù‡Ø¯ & Ø§Ø±Ø¨Ø­
    </button>

    <div class="points" style="margin-top:14px;">
      ğŸ’¸ Ø³Ø­Ø¨ Ø§Ù„Ø§Ø±Ø¨Ø§Ø­
      <!-- Withdraw Instructions (Auto) -->
<div id="withdrawNote" class="note" style="text-align:right; line-height:1.8; margin-top:10px;">
  <b>ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø­Ø¨:</b><br>
  ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª.
</div>
      <div class="grid">
        <input id="w_amount" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 5000)">
        <select id="w_method" onchange="updateWithdrawNote()"
        style="padding:12px;border-radius:12px;border:none;">
  <option value="">-- Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨ --</option>
  <option value="usdt">USDT (BEP20)</option>
  <option value="stcpay">STC Pay</option>
  <option value="paypal">PayPal</option>
</select>
        <input id="w_address" type="text" placeholder="Ø§Ù„Ù…Ø­ÙØ¸Ø© / Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ / Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„">
        <button onclick="requestWithdraw()">Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</button>
      </div>
    </div>

    <div class="msg" id="msg"></div>

    <div class="note">Ads appear only after user interaction</div>
  </div>

  <script>
    // ===== Supabase config =====
    const SUPABASE_URL = "https://tvubifjpkrsjrwjkayvm.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dWJpZmpwa3JzanJ3amtheXZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MTg2MzQsImV4cCI6MjA4MjI5NDYzNH0.Qfr7d65GaV2PojXc036e2UX7s9m_qo9L4fnbpdHxppE";

    // ===== UI refs =====
    const pointsEl = document.getElementById("points");
    const msgEl = document.getElementById("msg");
    const btn = document.getElementById("watchBtn");

    function setMsg(text, cls) {
      msgEl.textContent = text || "";
      msgEl.className = "msg " + (cls || "");
    }

    // ===== Local fallback =====
    const POINTS_KEY = "erbha_points";
    function loadLocalPoints() {
      const p = Number(localStorage.getItem(POINTS_KEY) || 0);
      pointsEl.textContent = String(p);
      return p;
    }
    function saveLocalPoints(p) {
      localStorage.setItem(POINTS_KEY, String(p));
      pointsEl.textContent = String(p);
    }

    // ===== Auth state =====
    let authed = false;
    let serverBalance = 0;
    let initDataCached = "";

    async function postFunction(path, body) {
      const res = await fetch(`${SUPABASE_URL}/functions/v1/${path}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON,
          "Authorization": `Bearer ${SUPABASE_ANON}`
        },
        body: JSON.stringify(body)
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || `Request failed (${res.status})`);
      return data;
    }

    async function authWithTelegram() {
      try {
        const TG = window.Telegram?.WebApp;
        if (!TG) throw new Error("Open inside Telegram");

        TG.ready();
        TG.expand();

        const initData = TG.initData || "";
        initDataCached = initData;
        if (!initDataCached) throw new Error("Missing initData");

        const out = await postFunction("auth", { initData: initDataCached });
        serverBalance = Number(out.balance || 0);
        pointsEl.textContent = String(serverBalance);

        authed = true;
        setMsg("âœ… Verified with Telegram", "ok");
      } catch (e) {
        authed = false;
        serverBalance = 0;
        loadLocalPoints();
        setMsg("â„¹ï¸ Local mode (open from Telegram to sync points).", "");
        console.log("Auth failed:", e?.message || e);
      }
    }

    authWithTelegram();

    // ===== Reward (secure: initData) =====
    async function watchRewardedAd() {
      setMsg("");
      btn.disabled = true;

      try {
        if (typeof show_10376707 !== "function") {
          throw new Error("Ad is loading, try again in a few seconds.");
        }

        await show_10376707();

        if (!authed || !initDataCached) {
          throw new Error("Not verified with Telegram.");
        }

        const event_key = `${Date.now()}:${Math.random().toString(16).slice(2)}`;

        const out = await postFunction("reward", {
          initData: initDataCached,
          event_key,
          points: 2
        });

        serverBalance = Number(out.balance || 0);
        pointsEl.textContent = String(serverBalance);
        setMsg("âœ… You watched the ad! +2 points added (server).", "ok");
      } catch (e) {
        setMsg("âŒ " + (e?.message || e), "err");
        console.log("Reward error:", e);
      } finally {
        btn.disabled = false;
      }
    }

    // ===== Withdraw (secure: initData) =====
    async function requestWithdraw() {
      try {
        if (!authed || !initDataCached) throw new Error("Not verified with Telegram.");

        const amount = Number(document.getElementById("w_amount").value || 0);
        const method = String(document.getElementById("w_method").value || "");
        const address = String(document.getElementById("w_address").value || "");
      // ===== Validation Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ =====
if (!method) throw new Error("Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨ Ø£ÙˆÙ„Ø§Ù‹.");

// âœ… ÙÙ‚Ø· 5000 Ù†Ù‚Ø·Ø© Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© Ø³Ø­Ø¨
if (!Number.isFinite(amount) || amount !== 5000) {
  throw new Error("Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…ØªØ§Ø­ Ù‡Ùˆ 5000 Ù†Ù‚Ø·Ø© ÙÙ‚Ø· Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© (5$).");
}

if (method === "usdt") {
  const ok = /^0x[a-fA-F0-9]{40}$/.test(address.trim());
  if (!ok) throw new Error("Ø¹Ù†ÙˆØ§Ù† USDT (BEP20) ØºÙŠØ± ØµØ­ÙŠØ­. Ù„Ø§Ø²Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 0x.");
}

if (method === "stcpay") {
  const a = address.trim().replace(/\s+/g, "");
  const ok = /^(05\d{8}|5\d{8}|\+9665\d{8}|9665\d{8})$/.test(a);
  if (!ok) throw new Error("Ø±Ù‚Ù… STC Pay ØºÙŠØ± ØµØ­ÙŠØ­. Ù…Ø«Ø§Ù„: 05xxxxxxxx");
}

if (method === "paypal") {
  const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(address.trim());
  if (!ok) throw new Error("Ø¨Ø±ÙŠØ¯ PayPal ØºÙŠØ± ØµØ­ÙŠØ­.");
}

        const out = await postFunction("withdraw", {
          initData: initDataCached,
          amount_points: amount,
          payout_method: method,
          payout_address: address
        });

        serverBalance = Number(out.balance || 0);
        pointsEl.textContent = String(serverBalance);
        setMsg("âœ… Withdraw request sent (pending).", "ok");
      } catch (e) {
        setMsg("âŒ " + (e?.message || e), "err");
        console.log("Withdraw error:", e);
      }
    }

    // expose
    window.watchRewardedAd = watchRewardedAd;
    window.requestWithdraw = requestWithdraw;
    
    function updateWithdrawNote() {
  const method = document.getElementById("w_method").value;
  const note = document.getElementById("withdrawNote");
  const addr = document.getElementById("w_address");

  // Ù†Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚Ù„ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
  addr.value = "";

  if (method === "usdt") {
    addr.placeholder = "Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© USDT (BEP20) ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 0x...";
    note.innerHTML = `
      <b>ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø­Ø¨:</b><br>
      â€¢ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… <b>Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© USDT (BEP20)</b> ÙÙ‚Ø·.<br>
      <span style="color:#fca5a5;"><b>Ø£ÙŠ Ø´Ø¨ÙƒØ© Ø£Ø®Ø±Ù‰ Ø³ÙŠØªÙ… Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨.</b></span>
    `;
  } else if (method === "stcpay") {
    addr.placeholder = "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù€ STC Pay (05xxxxxxxx)";
    note.innerHTML = `
      <b>ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø­Ø¨:</b><br>
      â€¢ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… <b>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù€ STC Pay</b>.<br>
      <span style="color:#fca5a5;"><b>Ø£ÙŠ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­ Ø³ÙŠØªÙ… Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨.</b></span>
    `;
  } else if (method === "paypal") {
    addr.placeholder = "Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯ PayPal Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (example@email.com)";
    note.innerHTML = `
      <b>ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø­Ø¨:</b><br>
      â€¢ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… <b>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø­Ø³Ø§Ø¨ PayPal</b>.<br>
      <span style="color:#fca5a5;"><b>Ø£ÙŠ Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø³ÙŠØªÙ… Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨.</b></span>
    `;
  } else {
    addr.placeholder = "Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨ Ø£ÙˆÙ„Ø§Ù‹";
    note.innerHTML = `
      <b>ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø­Ø¨:</b><br>
      ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª.
    `;
  }
}
  </script>
</body>
</html>
